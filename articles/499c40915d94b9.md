---
title: "【Nexy.js】個人的お気に入りの環境構築"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [nextjs]
published: false
---
Next.jsプロジェクトで開発するに当たり、個人的お気に入りの環境構築方法をまとめます。
<!-- TypeScript, ESLint, Prettier, Huskyなどを導入する手順をまとめます。 -->

## Next.jsインストール

公式ページの通りにNext.jsをセットアップします。

```bash
npx create-next-app@latest
```

対話形式で質問されるので、以下のように回答します。

```bash
? What is your project named? › my-app
# プロジェクト名を入力

? Would you like to use TypeScript? › No / Yes
# Yes を選択

? Would you like to use ESLint? › No / Yes
# Yes を選択

? Would you like to use Tailwind CSS? › No / Yes
# 好みで選択（個人的には No を選択している）

? Would you like to use `src/` directory? › No / Yes
# 好みで選択（個人的には Yes にしている）

? Would you like to use App Router? (recommended) … No / Yes
# Yes を選択

? Would you like to customize the default import alias (@/*)? … No / Yes
# No を選択
```

セットアップが完了すると、以下のようなディレクトリ構成でプロジェクトが作成されているはずです。

```bash
.
├── public
├── src
│   └── app
│       ├── favicon.ico
│       ├── globals.css
│       ├── layout.tsx
│       ├── page.module.cs
│       └── page.tsx
├── .gitignore
├── eslint.config.mjs
├── next-env.d.ts
├── next.config.js
├── package-lock.json
├── package.json
├── README.md
└── tsconfig.json
```

ローカルサーバを起動させ、問題なければここで一度リモートに`git push`しておきます。

```bash
npm run dev
```

## Prettierの設定

コードフォーマットを行うために、Prettierと関連プラグインをインストールします。

```bash
npm i -D prettier prettier-plugin-organize-imports
```

`prettier-plugin-organize-imports`はimport文をフォーマットしてくれるプラグインで、主に以下の3つのことをしてくれます。

- import文をアルファベット順で並び替え
- 冗長に書かれたimport文を統合
- importされたものの未使用なものの削除

https://www.npmjs.com/package/prettier-plugin-organize-imports

rootディレクトリに以下の内容でPrettierの設定ファイルを作成します。

```json:.prettier
{
  "trailingComma": "all",
  "tabWidth": 2,
  "useTabs": false,
  "semi": false,
  "singleQuote": true,
  "jsxSingleQuote": false,
  "arrowParens": "always",
  "printWidth": 100,
  "bracketSpacing": true,
  "plugins": ["prettier-plugin-organize-imports"],
  "overrides": [
    {
      "files": "*.html",
      "options": {
        "printWidth": 360
      }
    },
    {
      "files": ["*.css", "*.scss"],
      "options": {
        "singleQuote": false
      }
    }
  ]
}
```

フォーマットの対象外を定義したファイルもrootディレクトリ上に作成します。

```json:.prettierignore
node_modules/
.next/
build/
dist/
out/
public/
package-lock.json
yarn.lock
pnpm-lock.yaml
next.config.js
```

本質的にリントやフォーマットが重要でないファイルは、ここで除外しています。

## ESLintの設定

ESLintでは下記パッケージを追加でインストールします。

```bash
npm i -D @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-config-prettier
```

- [@typescript-eslint/eslint-plugin](https://typescript-eslint.io/getting-started/)
  - TypeScriptの推奨ルールを提供するプラグイン
- [@typescript-eslint/parser](https://typescript-eslint.io/getting-started/)
  - TypeScriptを解析するためのパーサ
- [eslint-config-prettier](https://github.com/prettier/eslint-config-prettier)
  - PrettierとESLintを併用するための競合ルールを解消する共有設定

rootディレクトリ上に以下の内容でESLintの設定ファイルを作成します。
※eslint v9系以降では設定ファイルの書き方が変わっているため注意

```json:eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/consistent-type-imports": [
      "error",
      {
        "prefer": "type-imports",
        "fixStyle": "separate-type-imports"
      }
    ],
    "@typescript-eslint/no-unused-vars": [
      "warn",
      {
        "vars": "all",
        "varsIgnorePattern": "^_",
        "args": "after-used",
        "argsIgnorePattern": "^_"
      }
    ],
    "object-shorthand": "error",
    "react/jsx-curly-brace-presence": "error",
    "react/self-closing-comp": [
      "error",
      {
        "component": true,
        "html": false
      }
    ],
    "@next/next/no-img-element": "off"
  },
  "ignorePatterns": [
    "node_modules/",
    ".next/",
    "build/",
    "dist/",
    "out/",
    "public/",
    "package-lock.json",
    "next.config.js",
    "tsconfig.json",
    "src/env.d.ts",
    "*.cjs",
    "*.mjs"
  ]
}
```

## VS Codeの設定

ファイルを保存時舌タイミングでPrettierによるコードフォーマットが行われるように、次の内容で`.vscode/settings.json`をrootディレクトリ上に作成します。

```json:.vscode/settings.json
{
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.formatOnSave": false,
  "editor.formatOnPaste": true,
  "editor.codeActionsOnSave": {
    "source.addMissingImports": "explicit",
    "source.fixAll.eslint": "explicit"
  },
  "javascript.preferences.importModuleSpecifier": "non-relative",
  "typescript.preferences.importModuleSpecifier": "non-relative",
  "eslint.validate": [
    "html",
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact"
  ]
}
```

## npmコマンドの設定

`npm-run-all`というパッケージを使用して、npmコマンドを追加します。

```bash
npm i -D npm-run-all
```

```diff json: package.json
{
 "scripts": {
   "dev": "next dev",
   "build": "next build",
   "start": "next start",
-  "lint": "next lint"
+  "lint": "run-p -l -c --aggregate-output lint:*",
+  "lint:eslint": "eslint .",
+  "lint:prettier": "prettier --check .",
+  "fix": "run-s fix:prettier fix:eslint",
+  "fix:eslint": "npm run lint:eslint -- --fix",
+  "fix:prettier": "npm run lint:prettier -- --write",
  },
}
```

## Huskyの設定

ここまでの設定で、コーディング中に自動でフォーマットが行われるようになっていますが、Huskyとlint-stagedを導入し、コミット前にも自動でESLintとPrettierが実行されるようにします。

```bash
npm i -D husky lint-staged
```

インストールできたら、下記コマンドでHuskyによるGitフックを有効化します。
コマンドを実行すると`.husky`というディレクトリが作成されます。

```bash
npx husky install
```

次に他の開発者が`npm i`などでパッケージをインストールした際に、自動的にHuskyを利用する準備が行われるよう、`package.json`に`prepare`コマンドを追加します。

```bash
npm pkg set scripts.prepare="husky install"
```

`.husky/pre-commit`ファイルの中身を下記の内容で書き換えます。

```txt
npx lint-staged
```

`package.json`にlint-stagedで行う処理を追加します。

```diff json:package.json
{
  ...{},
+ "lint-staged": {
+   "src/**/*.{js,jsx,ts,tsx}": [
+     "eslint --fix",
+     "prettier --write"
+   ]
+ }
}
```

こえで`git commit`を行うと、`pre-commit`のタイミングでステージングされたファイルに応じて`package.json`の`lint-staged`に記述したESLintとPrettierが実行されます。

## GitHub Actionsの設定

PRを作成したタイミングで簡易的なCIが走るようにGitHub Actionsの設定を行います。

下記の内容でymlファイルを作成します。

```yml:build.yml

name: Build Test
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: cache node_modules
        uses: actions/cache@v4
        id: node_modules_cache_id
        env:
          cache-name: cache-node_modules
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}

      - name: install dependencies
        if: ${{ steps.node_modules_cache_id.outputs.cache-hit != 'true' }}
        run: npm i

      - name: Run Lint
        run: npm run lint

      - name: Build
        run: npm run build
```

次にPRに自分自身をアサインするためのymlファイルを作成します。

```yml: assign_author.yml
on:
  pull_request:
    types: [opened]
name: Assign author to PR
jobs:
  assignAuthor:
    name: Assign author to PR
    permissions:
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Assign author to PR
        uses: technote-space/assign-author@v1
```

これでGitHubでPRを作成したときに、自動でbuildテストとPRに自分自身がアサインされるようになります。

## 参考にした記事

https://zenn.dev/siakas/articles/05481bdefacd13
