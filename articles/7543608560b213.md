---
title: "Cloudflare D1 Ã— Drizzle ã‚’ä½¿ã£ãŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['cloudflare', 'd1', 'drizzleorm', 'wrangler']
published: true
---

## ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€‚[D.suke](https://x.com/0614d_suke)ã§ã™ã€‚

ç¾åœ¨é–‹ç™ºã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§[Cloudflare](https://www.cloudflare.com/ja-jp/)ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’Cloudflare D1 Ã— Drizzleã‚’ä½¿ã£ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸã®ã§ã€ãã®æ‰‹é †ã‚’ç°¡å˜ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

## ç’°å¢ƒ
- node: 20.18.1
- next: 15.3.1
- drizzle-orm: 0.43.1
- drizzle-kit: 0.31.0
- @cloudflare/workers-types: 4.20250430.0

## Step1: Cloudflare D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
[Cloudflare](https://www.cloudflare.com/ja-jp/)ã®Dashboardã«ãƒ­ã‚°ã‚¤ãƒ³

1. å¯¾è±¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€â†’ã€ŒD1 SQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã¸ç§»å‹•
3. ã€ŒCreate Databaseã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹
4. ä»¥ä¸‹ã‚’å…¥åŠ›ã—ã¦ä½œæˆ

Database name: ä¾‹ï¼‰my-database

## Step2: wrangler.tomlã®ä½œæˆ
```:wrangler.toml
name = "worker_name"                  # Workerã®åå‰
compatibility_date = "2024-05-01"

[[d1_databases]]
binding = "DB"
database_name = ""                    # Step1ã§ä½œæˆã—ãŸåå‰
database_id = ""                      # Cloudflareå´ã§ç¢ºèª
migrations_dir = "./migrations"       # Drizzleç”¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡ºåŠ›å…ˆ
```

database_id ã¯Cloudflareã®D1è©³ç´°ç”»é¢ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

## step3: drizzle.config.tsã®ä½œæˆ
```ts:drizzle.config.ts
import type { Config } from 'drizzle-kit'

export default {
  schema: './src/db/schema.ts',
  out: './migrations',
  driver: 'd1-http',
  dialect: 'sqlite',
  dbCredentials: {
    accountId: '',
    databaseId: '',
    token: '',
  },
} satisfies Config
```
`accountId`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯ã€Cloudflare Account IDã‚’æŒ‡å®šã—ã¾ã™ã€‚

1. Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰Workers & Pagesã‚’é–‹ã
2. ç”»é¢å†…ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹Account IDå–å¾—

`databaseId`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯ã€Cloudflare D1 Database IDã‚’æŒ‡å®šã—ã¾ã™ã€‚

1. Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰D1ã‚’é–‹ã
2. ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰Database IDã‚’å–å¾—

`token`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯ã€Cloudflare API Tokensã‚’æŒ‡å®šã—ã¾ã™ã€‚

1. Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰Workers & Pagesã‚’é–‹ã„ã¦ã€Account IDã®ä¸‹ã«ã‚ã‚‹ã€ŒAPIãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã€ã‚’é–‹ã
2. APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆâ†’ã€Œã‚«ã‚¹ã‚¿ãƒ  ãƒˆãƒ¼ã‚¯ãƒ³ã€
3. ä»»æ„ã®ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›
4. æ¨©é™: ã€ŒD1ã€ã€ã€Œç·¨é›†ã€ã‚’é¸æŠ
5. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ãƒªã‚½ãƒ¼ã‚¹: ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ
6. æ¦‚è¦ã«é€²ã‚€ã‚’æŠ¼ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã‚’æŠ¼ã™
7. ä½œæˆã•ã‚ŒãŸAPIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

â€»`accountId`, `databaseId`, `token`ã¯`.env`ã«è¨˜è¼‰ã—ã¦ãŠãã¨å®‰å…¨ã§ã™ã€‚

## step4: schema.tsã®ä½œæˆ

```ts:src/db/schema.ts
import { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core'

export const users = sqliteTable('users', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  email: text('email').notNull(),
  createdAt: text('created_at').notNull(),
})
```

https://orm.drizzle.team/docs/column-types/sqlite

## step5: SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
```bash:bash
$ npx drizzle-kit generate
```
migrations/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« .sql ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

## step6: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```bash:bash
$ npx wrangler d1 migrations apply {database_name} --remote
```
--remote ã‚’ä»˜ã‘ãªã„ã¨ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ã—ã‹é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

## è£œè¶³
### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã«ã¯ï¼Ÿ
```bash:bash
$ npx wrangler d1 execute my-database --remote --command "SELECT * FROM users;"
```

### drizzle-kitã¨wranglerã®é–¢ä¿‚
- `drizzle-kit`: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆSQLï¼‰ã‚’ç”Ÿæˆ
- `wrangler`: ç”Ÿæˆã—ãŸ`.sql`ã‚’D1ã«é©ç”¨
